AWSTemplateFormatVersion: '2010-09-09'
Description: 'Minimal CDK Bootstrap for Match Scorer Project'

Parameters:
  Qualifier:
    Type: String
    Default: hnb659fds
    Description: 'Unique identifier for this bootstrap stack'
    AllowedPattern: "[A-Za-z0-9_-]{1,10}"

Resources:
  # ============================================
  # S3 Bucket for Lambda code and assets
  # ============================================
  StagingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'cdk-${Qualifier}-assets-${AWS::AccountId}-${AWS::Region}'
      AccessControl: Private
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256  # 使用 AWS 托管密钥，不需要额外的 KMS key
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: CleanupOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
          - Id: AbortIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: ManagedBy
          Value: CDK-Bootstrap
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain

  # S3 Bucket Policy - 强制 HTTPS
  StagingBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StagingBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowSSLRequestsOnly
            Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource:
              - !GetAtt StagingBucket.Arn
              - !Sub '${StagingBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: "false"

  # ============================================
  # ECR Repository for Docker images
  # ============================================
  ContainerAssetsRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub 'cdk-${Qualifier}-container-assets-${AWS::AccountId}-${AWS::Region}'
      ImageTagMutability: IMMUTABLE
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [{
              "rulePriority": 1,
              "description": "Expire untagged images after 365 days",
              "selection": {
                "tagStatus": "untagged",
                "countType": "sinceImagePushed",
                "countUnit": "days",
                "countNumber": 365
              },
              "action": { "type": "expire" }
            }]
          }
      RepositoryPolicyText:
        Version: "2012-10-17"
        Statement:
          - Sid: LambdaECRImageRetrievalPolicy
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - ecr:BatchGetImage
              - ecr:GetDownloadUrlForLayer
            Condition:
              StringLike:
                aws:sourceArn: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*'
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: ManagedBy
          Value: CDK-Bootstrap

  # ============================================
  # IAM Role: CloudFormation Execution
  # ============================================
  CloudFormationExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-cfn-exec-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      # 自定义策略 - 只包含项目需要的权限
      Policies:
        - PolicyName: CDKExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # VPC 和网络权限
              - Sid: VPCPermissions
                Effect: Allow
                Action:
                  - ec2:*Vpc*
                  - ec2:*Subnet*
                  - ec2:*Gateway*
                  - ec2:*Route*
                  - ec2:*SecurityGroup*
                  - ec2:*NetworkInterface*
                  - ec2:*Address*
                  - ec2:Describe*
                  - ec2:CreateTags
                  - ec2:DeleteTags
                Resource: '*'
              
              # ECS 权限
              - Sid: ECSPermissions
                Effect: Allow
                Action:
                  - ecs:*
                  - ecr:*
                Resource: '*'
              
              # Lambda 权限
              - Sid: LambdaPermissions
                Effect: Allow
                Action:
                  - lambda:*
                Resource: '*'
              
              # MSK/Kafka 权限
              - Sid: MSKPermissions
                Effect: Allow
                Action:
                  - kafka:*
                  - msk:*
                Resource: '*'
              
              # CloudWatch Logs 权限
              - Sid: LogsPermissions
                Effect: Allow
                Action:
                  - logs:*
                Resource: '*'
              
              # SSM Parameter Store 权限
              - Sid: SSMPermissions
                Effect: Allow
                Action:
                  - ssm:*
                Resource: '*'
              
              # S3 权限（用于 Lambda 代码和资产）
              - Sid: S3Permissions
                Effect: Allow
                Action:
                  - s3:*
                Resource: '*'
              
              # KMS 权限
              - Sid: KMSPermissions
                Effect: Allow
                Action:
                  - kms:Create*
                  - kms:Describe*
                  - kms:Enable*
                  - kms:List*
                  - kms:Put*
                  - kms:Update*
                  - kms:Revoke*
                  - kms:Disable*
                  - kms:Get*
                  - kms:Delete*
                  - kms:ScheduleKeyDeletion
                  - kms:CancelKeyDeletion
                  - kms:GenerateDataKey
                  - kms:Decrypt
                  - kms:Encrypt
                Resource: '*'
              
              # IAM 权限（创建 Lambda/ECS 需要的 roles）
              - Sid: IAMPermissions
                Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PassRole
                  - iam:CreatePolicy
                  - iam:DeletePolicy
                  - iam:CreatePolicyVersion
                  - iam:DeletePolicyVersion
                  - iam:TagRole
                  - iam:UntagRole
                  - iam:TagPolicy
                  - iam:UntagPolicy
                Resource: '*'
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: aws-cdk:bootstrap-role
          Value: cfn-exec

  # ============================================
  # IAM Role: Deployment Action
  # ============================================
  DeploymentActionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-deploy-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action:
              - sts:AssumeRole
              - sts:TagSession
      Policies:
        - PolicyName: DeploymentPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CloudFormationPermissions
                Effect: Allow
                Action:
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:DescribeStacks
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:CreateStack
                  - cloudformation:UpdateStack
                  - cloudformation:RollbackStack
                  - cloudformation:ContinueUpdateRollback
                  - cloudformation:DescribeStackEvents
                  - cloudformation:GetTemplate
                  - cloudformation:DeleteStack
                  - cloudformation:UpdateTerminationProtection
                  - cloudformation:GetTemplateSummary
                Resource: '*'
              
              - Sid: S3StagingBucket
                Effect: Allow
                Action:
                  - s3:GetObject*
                  - s3:GetBucket*
                  - s3:List*
                Resource:
                  - !GetAtt StagingBucket.Arn
                  - !Sub '${StagingBucket.Arn}/*'
              
              - Sid: PassRole
                Effect: Allow
                Action: iam:PassRole
                Resource: !GetAtt CloudFormationExecutionRole.Arn
              
              - Sid: ReadVersion
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/cdk-bootstrap/${Qualifier}/version'
              
              - Sid: GetCallerIdentity
                Effect: Allow
                Action: sts:GetCallerIdentity
                Resource: '*'
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: aws-cdk:bootstrap-role
          Value: deploy

  # ============================================
  # IAM Role: File Publishing (Lambda 代码)
  # ============================================
  FilePublishingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-file-publishing-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action:
              - sts:AssumeRole
              - sts:TagSession
      Policies:
        - PolicyName: FilePublishingPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject*
                  - s3:GetBucket*
                  - s3:GetEncryptionConfiguration
                  - s3:List*
                  - s3:DeleteObject*
                  - s3:PutObject*
                  - s3:Abort*
                Resource:
                  - !GetAtt StagingBucket.Arn
                  - !Sub '${StagingBucket.Arn}/*'
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: aws-cdk:bootstrap-role
          Value: file-publishing

  # ============================================
  # IAM Role: Image Publishing (Docker 镜像)
  # ============================================
  ImagePublishingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'cdk-${Qualifier}-image-publishing-role-${AWS::AccountId}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
            Action:
              - sts:AssumeRole
              - sts:TagSession
      Policies:
        - PolicyName: ImagePublishingPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:PutImage
                  - ecr:InitiateLayerUpload
                  - ecr:UploadLayerPart
                  - ecr:CompleteLayerUpload
                  - ecr:BatchCheckLayerAvailability
                  - ecr:DescribeRepositories
                  - ecr:DescribeImages
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                Resource: !GetAtt ContainerAssetsRepository.Arn
              - Effect: Allow
                Action: ecr:GetAuthorizationToken
                Resource: '*'
      Tags:
        - Key: Project
          Value: MatchScorer
        - Key: aws-cdk:bootstrap-role
          Value: image-publishing

  # ============================================
  # SSM Parameter: Bootstrap Version
  # ============================================
  CdkBootstrapVersion:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub '/cdk-bootstrap/${Qualifier}/version'
      Value: '27'
      Description: 'CDK Bootstrap version for Match Scorer'

Outputs:
  BucketName:
    Description: 'S3 Bucket for CDK Assets'
    Value: !Ref StagingBucket
    Export:
      Name: !Sub 'CdkBootstrap-${Qualifier}-BucketName'

  BucketDomainName:
    Description: 'S3 Bucket Domain Name'
    Value: !GetAtt StagingBucket.RegionalDomainName

  ImageRepositoryName:
    Description: 'ECR Repository for Container Images'
    Value: !Ref ContainerAssetsRepository
    Export:
      Name: !Sub 'CdkBootstrap-${Qualifier}-ImageRepositoryName'

  CloudFormationExecutionRoleArn:
    Description: 'CloudFormation Execution Role ARN'
    Value: !GetAtt CloudFormationExecutionRole.Arn

  DeploymentRoleArn:
    Description: 'Deployment Role ARN'
    Value: !GetAtt DeploymentActionRole.Arn

  BootstrapVersion:
    Description: 'Bootstrap Version'
    Value: !GetAtt CdkBootstrapVersion.Value
